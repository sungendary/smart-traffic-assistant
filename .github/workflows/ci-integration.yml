# ============================================================================
# CI Integration Workflow (선택적 실행)
# ============================================================================
# 목적: 주요 브랜치(main, develop_branch)에 merge 전 전체 검증
# 
# 주요 기능:
#   - 모든 CI 검증을 통합하고 순차적으로 실행
#   - 각 검증 단계의 결과를 종합
#
# 실행 조건:
#   - main 또는 develop_branch 브랜치에 push될 때만 실행
#   - Pull Request가 main/develop_branch로 merge될 때만 실행
#   - 수동 실행 (workflow_dispatch)
#
# 참고:
#   - feature 브랜치에서는 실행되지 않음 (개별 워크플로우만 실행)
#   - 각 워크플로우는 독립적으로 실행되며, 이 워크플로우는 선택적
# ============================================================================

name: CI Integration

on:
  push:
    branches:
      - main
      - develop_branch
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop_branch
  workflow_dispatch:

# workflow_call로 호출되는 워크플로우에 권한 전달
permissions:
  contents: read
  pull-requests: read  # security-baseline의 gitleaks PR 스캔을 위해 필요

jobs:
  # 코드 품질 검증 (린팅, 포맷팅, OpenAPI 검증)
  code-quality:
    uses: ./.github/workflows/backend-quality.yml
    secrets: inherit

  # 핵심 기능 테스트 (기능1, 2, 3)
  core-features:
    uses: ./.github/workflows/core-features-test.yml
    secrets: inherit

  # DB 연결 테스트 (MongoDB, Redis)
  db-connection:
    uses: ./.github/workflows/db-connection-test.yml
    secrets: inherit

  # 인증 플로우 테스트 (회원가입-로그인)
  auth-flow:
    uses: ./.github/workflows/auth-flow-test.yml
    secrets: inherit

  # 보안 검사 (모든 브랜치 및 PR에서 실행 - 조기 발견 중요)
  security-baseline:
    uses: ./.github/workflows/security-baseline.yml
    secrets: inherit

  # 모든 CI 검증 통과 확인
  ci-summary:
    needs: [code-quality, core-features, db-connection, auth-flow, security-baseline]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: CI Summary
        run: |
          echo "## CI Integration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 코드 품질 검증 (린팅, 포맷팅, OpenAPI) | ${{ needs.code-quality.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 핵심 기능 테스트 (기능1,2,3) | ${{ needs.core-features.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DB 연결 테스트 (MongoDB, Redis) | ${{ needs.db-connection.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 인증 플로우 테스트 (회원가입-로그인) | ${{ needs.auth-flow.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 보안 검사 (pip-audit, bandit, gitleaks) | ${{ needs.security-baseline.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.code-quality.result }}" != "success" ] || \
             [ "${{ needs.core-features.result }}" != "success" ] || \
             [ "${{ needs.db-connection.result }}" != "success" ] || \
             [ "${{ needs.auth-flow.result }}" != "success" ] || \
             [ "${{ needs.security-baseline.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **Some CI checks failed. Deployment will not proceed.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ **All CI checks passed! Ready for deployment.**" >> $GITHUB_STEP_SUMMARY
          fi

