# ============================================================================
# Release Workflow
# ============================================================================
# 목적: 릴리즈 버전 태깅 및 릴리즈 노트 생성
# 
# 주요 기능:
#   1. 버전 태그 생성 (semantic versioning)
#   2. 릴리즈 노트 자동 생성
#   3. GitHub Release 생성
#   4. 릴리즈 정보 기록
#
# 실행 조건:
#   - main 브랜치에 태그가 push될 때 (예: v1.0.0)
#   - 수동 실행 (workflow_dispatch)
#
# 사용 방법:
#   git tag -a v1.0.0 -m "Release version 1.0.0"
#   git push origin v1.0.0
# ============================================================================

name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # v1.0.0, v1.2.3 등의 태그
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/dating-app-api

jobs:
  # 릴리즈 생성 작업
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # GitHub Release 생성 권한
    
    steps:
      # 저장소 코드 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 전체 히스토리 가져오기

      # 버전 태그 결정
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          
          # v 접두사 제거 (있는 경우)
          VERSION_NUMBER="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_number=$VERSION_NUMBER" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      # 릴리즈 노트 생성
      - name: Generate release notes
        id: release-notes
        uses: actions/github-script@v7
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1
            });
            
            const lastRelease = releases.length > 0 ? releases[0].tag_name : null;
            const tag = '${{ steps.version.outputs.version }}';
            
            let releaseNotes = `## Release ${{ steps.version.outputs.version }}\n\n`;
            releaseNotes += `**Release Date:** ${new Date().toISOString().split('T')[0]}\n\n`;
            
            if (lastRelease) {
              releaseNotes += `**Changes since ${lastRelease}:**\n\n`;
            } else {
              releaseNotes += `**Initial Release**\n\n`;
            }
            
            // 커밋 메시지에서 변경사항 추출
            const { data: commits } = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: lastRelease || 'HEAD~10',
              head: tag
            });
            
            if (commits.commits.length > 0) {
              releaseNotes += `### Commits\n\n`;
              commits.commits.slice(0, 20).forEach(commit => {
                releaseNotes += `- ${commit.commit.message.split('\n')[0]} (${commit.sha.substring(0, 7)})\n`;
              });
            }
            
            releaseNotes += `\n### Docker Image\n\n`;
            releaseNotes += `- Image: \`${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version_number }}\`\n`;
            releaseNotes += `- Image: \`${{ env.IMAGE_NAME }}:latest\`\n`;
            
            core.setOutput('body', releaseNotes);
            return releaseNotes;

      # GitHub Release 생성
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          release_name: Release ${{ steps.version.outputs.version }}
          body: ${{ steps.release-notes.outputs.body }}
          draft: false
          prerelease: false

      # 릴리즈 정보 출력
      - name: Release information
        run: |
          echo "## Release Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Number:** ${{ steps.version.outputs.version_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Image:** ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Release:** https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY

